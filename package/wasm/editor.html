<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>ack-core editor</title>
    <meta charset="utf-8">
    <link rel="icon" href="data:;base64,=">
    <link rel="stylesheet" href="//cdn.webix.com/edge/skins/mini.css" type="text/css">
    <link rel="stylesheet" href="editor/styles.css">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <script src="editor/components.js" type="text/javascript"></script>
</head>
<body>
    <canvas class="rt" id="render_target"></canvas>
    <div class="editor" id="editor">
        <div class="top" id="top"></div>
        <div class="nodes" id="nodes"></div>
        <div class="inspect" id="inspect"></div>
        <div class="output" id="output"></div>
    </div>

    <script type="text/javascript" charset="utf-8">
        var editorRootDirectory = null;
    </script>    
    <script type="text/javascript" src="wasm.js" binary="editor.wasm"></script>
    <script type="text/javascript" charset="utf-8">
        ["nodes", "output", "inspect", "top"].forEach(name => {
            document.getElementById(name).addEventListener("pointerdown", (event) => {
                event.stopPropagation();
                return false;
            });
            document.getElementById(name).addEventListener("keydown", (event) => {
                if (event.key != "Enter") {
                    event.stopPropagation();
                }
                return false;
            });
            document.getElementById(name).addEventListener("keyup", (event) => {
                if (event.key != "Enter") {
                    event.stopPropagation();
                }
                return false;
            });
            document.getElementById(name).addEventListener("wheel", (event) => {
                event.stopPropagation();
                return false;
            });
        })

        const uiInspectMappingBasic = {
            "null" : [],
            "inspect_prefab" : ["node_0", "node_1_resource_list"],
            "inspect_mesh" : ["node_0", "node_1_resource_list"],
            "inspect_particles" : ["node_0", "node_1_resource_list"]
        };
        const uiInspectMappingEdit = {
            "null" : [],
            "inspect_prefab" : [],
            "inspect_mesh" : ["voxel_mesh_edit_0"],
            "inspect_particles" : ["particles_edit_0", "particles_edit_1", "particles_edit_2"]
        };
        const resourcesExtMapping = {
            "null" : [],
            "inspect_prefab" : [".txt"],
            "inspect_mesh" : [".vox", ".txt"],
            "inspect_particles" : [".txt", ".tga"]
        };
        const uiPtcShapeTypes = [
            { id: 1, value: "Disk"}, 
            { id: 2, value: "Box"}
        ];
        const uiPtcShapeDistribution = [
            { id: 1, value: "Random"}, 
            { id: 2, value: "Shuffled"},
            { id: 3, value: "Linear"}
        ];
        const uiPtcOrientation = [
            { id: 1, value: "Camera"}, 
            { id: 2, value: "Axis"},
            { id: 3, value: "World"}
        ];

        var uiNodeTree = null;
        var uiNodeName = null;
        var uiNodeTree = null;
        var uiInspectPanel = null;
        var uiInspectType = null;
        var uiResourceList = null;
        var listParticleTextures = [];
        var listResources = {};
        var dirBinaryData = null;
        var dirResources = null;

        let utility = {
            parseConfig: function(text) {
                convertValue = (type, raw) => {
                    raw = raw.trim();
                    if (type == "bool") return raw == "true";
                    if (type == "string") return raw.replace(/"(.*)"/, "$1");
                    if (type == "integer") return parseInt(raw, 10);
                    if (type && /^vector\d+f$/i.test(type)) return raw.split(/\s+/).map(Number);
                    if (type == "number") return parseFloat(raw);
                    return null;
                }
                parseBlock = (body) => {
                    const obj = {};
                    const blockRe = /(\w+)\s*\{([^{}]*\{[^}]*\}[^{}]*|[^{}]*)\}/gs;
                    let match;
                    while ((match = blockRe.exec(body)) != null) {
                        const [, name, inner] = match;
                        obj[name] = parseBlock(inner);
                        body = body.replace(match[0], "");
                    }

                    const lineRe = /(\w+)\s*:\s*(\w+)?\s*=?\s*([^\n{}]+)/g;
                    while ((match = lineRe.exec(body)) != null) {
                        const [, key, type, raw] = match;
                        obj[key] = convertValue(type, raw);
                    }

                    return obj;
                }
                return parseBlock(text);
            },
            getPathDirectoryAndName: async function(dirHandle, relPath) {
                const pathParts = relPath.split('/');
                var handle = dirHandle;
                for (let i = 0; i < pathParts.length; i++) {
                    if (i == pathParts.length - 1) {
                        return [handle, pathParts[i]];
                    }
                    else {
                        handle = await handle.getDirectoryHandle(pathParts[i], { create: true });
                    }
                }
            },
            listFilesInDirectory: async function(baseDirName, dirHandle, ext) {
                var result = [];
                for await (const value of dirHandle.values()) {                    
                    if (value.kind == "directory") {
                        subDirHandle = await dirHandle.getDirectoryHandle(value.name);
                        result = result.concat(await utility.listFilesInDirectory(baseDirName + '/' + value.name, subDirHandle, ext));
                    }
                    else if (value.name.endsWith(ext)) {
                        result.push(baseDirName + '/' + value.name.replace("." + ext, ""));
                    }
                }
                return result;
            },
            updateResourcesList: async function() {
                listResources["null"] = []
                listResources["inspect_mesh"] = await dirResources.getDirectoryHandle("meshes").then(r => utility.listFilesInDirectory("meshes", r, "vox"));
                listResources["inspect_mesh"].sort();
                listResources["inspect_particles"] = await dirResources.getDirectoryHandle("emitters").then(r => utility.listFilesInDirectory("emitters", r, "txt"));
                listResources["inspect_particles"].sort();
                listResources["inspect_prefab"] = await dirResources.getDirectoryHandle("prefabs").then(r => utility.listFilesInDirectory("prefabs", r, "txt"));
                listResources["inspect_prefab"].sort();
            },
            setWorkingDirectory: async function() {
                try {
                    editorRootDirectory = await window.showDirectoryPicker({ mode: "readwrite" });
                    dirResources = await editorRootDirectory.getDirectoryHandle("resources");
                    dirBinaryData = await editorRootDirectory.getDirectoryHandle("binary").then(r => r.getDirectoryHandle("data"));
                } 
                catch (error) {
                    webix.alert("Can't recognise working directory structure");
                    return false;
                }

                texturesRoot = await dirBinaryData.getDirectoryHandle("textures");
                listParticleTextures = await texturesRoot.getDirectoryHandle("particles").then(r => utility.listFilesInDirectory("textures/particles", r, "png"));
                listParticleTextures.sort();

                utility.updateResourcesList();
                return true;
            },
            setElementValue: function(name, value) {
                const e = $$(name);
                e.blockEvent();
                e.setValue(value);
                e.unblockEvent();
            },
            adjustTree: function(id, index) {
                uiNodeTree.define("width", 1000);
                uiNodeTree.resize();
                const leaves = uiNodeTree.$view.getElementsByClassName("webix_tree_leaves")[0];
                uiNodeTree.define("width", leaves.clientWidth);
                uiNodeTree.define("height", leaves.clientHeight);
                uiNodeTree.resize();
            },
            insertItemToNodeTree: function(name) {
                var lastParent = null;
                name.split('.').forEach(node => {
                    const current = lastParent ? lastParent + "." + node : node;
                    if (uiNodeTree.exists(current) == false) {
                        uiNodeTree.data.add({id: current, value: node, open: true}, -1, lastParent );
                    }
                    if (lastParent) {
                        uiNodeTree.open(lastParent);                        
                    }
                    lastParent = current;
                });
            },
            addItemToNodeTree: function(name, isPrefab) {
                utility.insertItemToNodeTree(name);

                if (isPrefab) {
                    uiNodeTree.getItem(name).isPrefab = isPrefab;
                    utility.highlightSubTree(name);
                }
                uiNodeTree.select(name);
            },
            highlightSubTree: function(id) {
                uiNodeTree.addCss(id, "highlight");
                uiNodeTree.data.eachSubItem(id, function(child) {
                    uiNodeTree.addCss(child.id, "highlight");
                });
                uiNodeTree.refresh(id);
            },
            showInspectPanel: function(panel, arg0) {
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic[panel].forEach(item => {
                    $$(item).show();
                });

                uiResourceList.clearAll();
                uiResourceList.parse(listResources[panel]);
                if (uiResourceList.exists(arg0)) {
                    uiResourceList.select(arg0);
                }
                else {
                    uiResourceList.unselectAll();
                }

                uiInspectType = panel;
            },
            hostUpdateResources: async function(handler) {
                try {
                    const response = await fetch("host_cmd_update");
                    if (!response.ok) {
                        throw new Error("Response status: ${response.status}");
                    }

                    handler();
                } 
                catch (error) {
                    console.error(error.message);
                }
            }
        }

        uiBindings = {
            setWorkingDirectory: async function(e) {
                let success = await utility.setWorkingDirectory();
                if (success) {
                    document.getElementById("nodes").style.visibility = "visible";
                    $$("top_buttons").show();
                    e.hide();                    
                }
            },
            resourceSaveAndExit: function(e) {
                $$("processing_popup").show();
                uiEditor.sendMsg("editor.resource.save", "");
            },
            resourceDiscardAndExit: function(e) {
                uiEditor.sendMsg("editor.stopEditing", "");
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                $$("edit_resource_buttons").hide();
                $$("node_1_resource_list").show();
            },
            treeNewNode: function(e) {
                $$("add_node_menu").show(e.getNode(), {pos: "right"});
            },
            treeDeleteNode: function(e) {
                uiEditor.sendMsg("editor.deleteNode", uiNodeTree.getSelectedId());
            },
            treeNodeSelected: function(id) {
                $$("edit_resource_buttons").hide();
                uiEditor.sendMsg("editor.stopEditing", "");
                uiEditor.sendMsg("editor.selectNode", id);
            },
            spaceClick: function(e) {
                $$("edit_resource_buttons").hide();
                uiEditor.sendMsg("editor.stopEditing", "");
                uiNodeTree.unselectAll();
                uiEditor.sendMsg("editor.clearNodeSelection", "");
                utility.showInspectPanel("null", "");
            },
            nodeName: function(e, nv, old) {
                if (/^(?!\.)[A-Za-z0-9_.]+(?<!\.)$/.test(nv) && !uiNodeTree.exists(nv)) {
                    uiEditor.sendMsg("editor.renameNode", old + " " + nv);
                }
                else {
                    utility.setElementValue(e.data.id, old);
                }
            },
            nodeMove: function(e, nv, old) {
                let args = $$("inspect_node_x").getValue() + " " + $$("inspect_node_y").getValue() + " " + $$("inspect_node_z").getValue()
                uiEditor.sendMsg("editor.moveNode", args);
            },
            nodeStartEdit: function(e) {
                uiEditor.sendMsg("editor.startEditing", "");
            },
            meshOffset: function(e, nv, old) {
                let args = $$("inspect_mesh_cx").getValue() + " " + $$("inspect_mesh_cy").getValue() + " " + $$("inspect_mesh_cz").getValue()
                uiEditor.sendMsg("editor.mesh.offset", args);
            },
            particlesEmission: function(e, nv, old) {
                if (e.data.id == "inspect_ptc_lifetime") {
                    let isLooped = parseInt($$("inspect_ptc_looped").getValue());
                    if (isLooped && parseInt(nv) > parseInt($$("inspect_ptc_emission_time").getValue())) {
                        utility.setElementValue(e.data.id, old);
                    }
                }
                if (e.data.id == "inspect_ptc_looped") {
                    let lifeTime = parseInt($$("inspect_ptc_lifetime").getValue());
                    let emissionTime = parseInt($$("inspect_ptc_emission_time").getValue())
                    if (nv && lifeTime > emissionTime) {
                        utility.setElementValue("inspect_ptc_lifetime", emissionTime);
                    }
                }
                let args = $$("inspect_ptc_emission_time").getValue() + " " + $$("inspect_ptc_lifetime").getValue() + " ";
                args += $$("inspect_ptc_baking_time").getValue() + " " + $$("inspect_ptc_count").getValue() + " " + $$("inspect_ptc_looped").getValue();
                uiEditor.sendMsg("editor.particles.emission", args);
            },
            particlesVisual: function(e, nv, old) {
                let args = $$("inspect_ptc_sshape_type").getValue() + " " + $$("inspect_ptc_sshape_fill").getValue() + " ";
                args += $$("inspect_ptc_sshape_arg0").getValue() + " " + $$("inspect_ptc_sshape_arg1").getValue() + " " + $$("inspect_ptc_sshape_arg2").getValue() + " ";
                args += $$("inspect_ptc_eshape_type").getValue() + " " + $$("inspect_ptc_eshape_fill").getValue() + " ";
                args += $$("inspect_ptc_eshape_arg0").getValue() + " " + $$("inspect_ptc_eshape_arg1").getValue() + " " + $$("inspect_ptc_eshape_arg2").getValue() + " ";
                args += $$("inspect_ptc_end_offset_x").getValue() + " " + $$("inspect_ptc_end_offset_y").getValue() + " " + $$("inspect_ptc_end_offset_z").getValue() + " ";
                args += $$("inspect_ptc_shape_distr").getValue() + " " + $$("inspect_ptc_orientation").getValue();
                uiEditor.sendMsg("editor.particles.visual", args);
            },
            prefabSave: function(e) {
                uiEditor.sendMsg("editor.savePrefab", "");
            },
            deleteResource: async function(e) {
                let path = uiResourceList.getSelectedId();
                if (path.length) {
                    try {
                        let [dir, name] = await utility.getPathDirectoryAndName(dirResources, path);
                        const exts = resourcesExtMapping[uiInspectType];
                        for (const ext of exts) {
                            let file = await dir.getFileHandle(name + ext);
                            await file.remove();
                        }
                    } 
                    catch (error) {}
                }
                listResources[uiInspectType] = listResources[uiInspectType].filter(item => item !== path);
                uiResourceList.remove(path);
                uiEditor.sendMsg("editor.setPath", "");
                uiEditor["engine.refresh"]();
            },
            cloneResource: async function(e) {
                let path = uiResourceList.getSelectedId();
                if (path.length) {
                    webix.prompt({
                        title: "Clone with a new name", ok: "Clone", cancel: "Cancel", input: { value: path }
                    }).then(async (newPath) => {
                        $$("processing_popup").show();
                        try {
                            let [dstDir, dstName] = await utility.getPathDirectoryAndName(dirResources, newPath);
                            let [srcDir, srcName] = await utility.getPathDirectoryAndName(dirResources, path);
                            const exts = resourcesExtMapping[uiInspectType];
                            for (const ext of exts) {
                                try {
                                    let file = await dstDir.getFileHandle(dstName + ext);
                                    await file.remove();
                                } 
                                catch (error) {}

                                const srcFileHandle = await srcDir.getFileHandle(srcName + ext);
                                const srcFile = await srcFileHandle.getFile();
                                const dstFileHandle = await dstDir.getFileHandle(dstName + ext, { create: true });
                                const writable = await dstFileHandle.createWritable();
                                await writable.write(srcFile);
                                await writable.close();
                            }
                        } 
                        catch (error) {}
                        await utility.updateResourcesList();
                        await utility.hostUpdateResources(() => {
                            if (!uiResourceList.exists(newPath)) {
                                uiResourceList.add({ id: newPath, value: newPath });
                            }
                            uiEditor.sendMsg("editor.reloadResources", newPath);
                        });
                    });
                }
            }
        }
        
        webix.ui({
            container: "top",
            margin: 0,
            rows: [
                {cols: [
                    elements.button("\uD83D\uDDC4", "Set working directory", uiBindings.setWorkingDirectory),
                    {
                        id: "top_buttons",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDCE4", "Load scene"),
                            elements.button("\uD83D\uDCBE", "Save scene"),
                            elements.toggle('<img src="editor/arrows.svg"></img>', '<img src="editor/arrows.svg"></img>', true, "Hide/show moving tool", (e, nv) => {})
                        ]
                    },
                    {},
                    {
                        id: "edit_resource_buttons",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDCBE", "Save resource & Exit", uiBindings.resourceSaveAndExit),
                            elements.button("\uD83D\uDEAB", "Discard changes in the resource & Exit", uiBindings.resourceDiscardAndExit)
                        ]
                    },

                ], autoheight: true}
            ]
        });
        webix.ui({
            container: "nodes",
            cols: [
                {rows: [
                        elements.button("\u2795", "New node", uiBindings.treeNewNode),
                        elements.button("\u274C", "Delete node", uiBindings.treeDeleteNode),
                        elements.button("\uD83D\uDCBE", "Save prefab", uiBindings.prefabSave),
                        {}
                ]},
                {rows: [
                        {
                            id: "node_tree", view: "tree", type: "lineTree", select: true, borderless: true, scroll: false, checkbox: true, data: [],
                            template: "{common.icon()}{common.checkbox()}&nbsp;#value#",
                            css: { "background" : "transparent", "color" : "lightGray" },
                            on: {
                                onAfterOpen: utility.adjustTree,
                                onAfterClose: utility.adjustTree,
                                onAfterAdd: utility.adjustTree,
                                onAfterSelect: uiBindings.treeNodeSelected
                            }
                        },
                        { id: "space"}
                ]}
            ]
        });
        webix.ui({
            id: "add_node_menu", container: "editor", view: "contextmenu", master: "nodes",
            data: [
                { id: "0", value: "Add Prefab" },
                { id: "1", value: "Add Voxel Mesh" },
                { id: "2", value: "Add Particles" }
            ],
            submenuConfig: {
                type: {
                    height: 22
                },
            },
            on: {
                onMenuItemClick: function(id, e, node) {
                    uiEditor.sendMsg("editor.createNode", id);
                }
            }
        });
        webix.ui({
            id: "inspect_panel", container: "inspect", view: "accordion", type: "clean", multi: true, borderless: true,
            rows: [
                {
                    id: "node_0", view: "accordionitem", hidden: true, header: "Parameters", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Name:"),
                                elements.text("inspect_node_name", "", 183, false, uiBindings.nodeName),
                            ]},
                            {cols: [
                                elements.label("Position:"),
                                {},
                                elements.number("inspect_node_x", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                                elements.number("inspect_node_y", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                                elements.number("inspect_node_z", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "node_1_resource_list", view: "accordionitem", hidden: true, header: "Resource List", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        cols: [
                            {rows: [
                                {
                                    id: "node_resource_list",
                                    view: "list", height: 300, select: true,
                                    type: {
                                        height: 22
                                    },
                                    data: ["lib/path/aaa1", "lib/path/bbbbbbbb1", "lib/path/cc1"],
                                    on: {
                                        onAfterSelect: function(path) {
                                            uiEditor.sendMsg("editor.setPath", path);
                                        }
                                    }
                                },
                                { height: 16 }
                            ]},
                            {
                                width: 28,
                                css: {"margin-left": "3px !important"},
                                rows: [
                                    elements.button("\uD83D\uDEE0", "Edit resource", uiBindings.nodeStartEdit),
                                    elements.button("\u2FFB", "Clone resource", uiBindings.cloneResource),
                                    elements.button("\u274C", "Delete resource", uiBindings.deleteResource)
                                ]
                            }
                        ]
                    }
                },
                {
                    id: "voxel_mesh_edit_0", view: "accordionitem", hidden: true, header: "Edit Mesh", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Center point:"),
                                {},
                                elements.number("inspect_mesh_cx", null, 44, "11111", 0, 1, -99, 99, uiBindings.meshOffset),
                                elements.number("inspect_mesh_cy", null, 44, "11111", 0, 1, -99, 99, uiBindings.meshOffset),
                                elements.number("inspect_mesh_cz", null, 44, "11111", 0, 1, -99, 99, uiBindings.meshOffset)
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "particles_edit_0", view: "accordionitem", hidden: true, header: "Emission", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Particles emission time (ms):"), {},
                                elements.number("inspect_ptc_emission_time", "", 60, "11111", 1000, 1, 1, 4000, uiBindings.particlesEmission),
                            ]},
                            elements.graphedit("inspect_ptc_emission_graph", "Emission", 1.0, 0.0, 1.0, 0.0),
                            {cols: [
                                elements.label("Particles life time (ms):"), {},
                                elements.number("inspect_ptc_lifetime", "", 60, "11111", 1000, 1, 1, 4000, uiBindings.particlesEmission),
                            ]},
                            {cols: [
                                elements.label("Baking frame time (ms):"), {},
                                elements.number("inspect_ptc_baking_time", "", 60, "11111", 33, 1, 10, 100, uiBindings.particlesEmission)
                            ]},
                            {cols: [
                                elements.label("Amount of particles to emit:"), {},
                                elements.number("inspect_ptc_count", "", 60, "11111", 10, 1, 1, 1000, uiBindings.particlesEmission),
                            ]},
                            {cols: [
                                elements.button("\u25b6", "Restart"), 
                                elements.label("Looped:"),
                                elements.checkbox("inspect_ptc_looped", false, uiBindings.particlesEmission), { width: 10 },
                                elements.label("Seed:"),
                                elements.text("inspect_ptc_rnd_seed", "0", 70, true),
                                elements.button("\uD83C\uDFB2", "Reroll and reevaluate all randomized parameters")
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "particles_edit_1", view: "accordionitem", hidden: true, header: "Visual", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Start shape type:"), { width: 2 },
                                elements.combo("inspect_ptc_sshape_type", 0, uiPtcShapeTypes, 88, uiBindings.particlesVisual),
                                elements.label("Fill:"),
                                elements.checkbox("inspect_ptc_sshape_fill", false, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("Start shape args:"), {},
                                elements.number("inspect_ptc_sshape_arg0", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_sshape_arg1", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_sshape_arg2", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                            ]},
                            {cols: [
                                elements.label("End shape type:"), { width: 8 },
                                elements.combo("inspect_ptc_eshape_type", 0, uiPtcShapeTypes, 88, uiBindings.particlesVisual),
                                elements.label("Fill:"),
                                elements.checkbox("inspect_ptc_eshape_fill", false, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("End shape args:"), {},
                                elements.number("inspect_ptc_eshape_arg0", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_eshape_arg1", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_eshape_arg2", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("End shape offset:"), {},
                                elements.number("inspect_ptc_end_offset_x", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_end_offset_y", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_end_offset_z", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("Start-to-End Mapping:"),
                                elements.combo("inspect_ptc_shape_distr", 0, uiPtcShapeDistribution, 106, uiBindings.particlesVisual),
                            ]},
                            {cols: [
                                elements.label("Particle orientation:"), {},
                                elements.combo("inspect_ptc_orientation", 0, uiPtcOrientation, 106, uiBindings.particlesVisual),
                            ]},
                            {cols: [
                                elements.label("Texture:"),
                                elements.combo("inspect_ptc_texture", "", listParticleTextures, 175, (e, nv, old) => {

                                }),
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "particles_edit_2", view: "accordionitem", hidden: true, header: "Dynamic", collapsed: true, headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            elements.graphedit("inspect_ptc_width_graph", "Ptc Width", 1.0, 0.0, 99.0, 99.0),
                            elements.graphedit("inspect_ptc_height_graph", "Ptc Height", 1.0, 0.0, 99.0, 99.0),
                            elements.graphedit("inspect_ptc_speed_graph", "Ptc Speed", 10.0, -999.0, 999.0, 999.0),
                            elements.graphedit("inspect_ptc_alpha_graph", "Ptc Alpha", 1.0, 0.0, 1.0, 1.0),
                            { height: 16 }
                        ]
                    }
                }
            ]
        });
        webix.ui({
            view: "popup",
            id: "processing_popup",
            height: 50,
            width: 150,
            modal: true,
            position: "center",
            body: {
                padding:{
                    left: 20, right: 20
                },
                rows: [
                    elements.label("Processing...")
                ]
            }
        });
        webix.event($$("space").getNode(), "click", uiBindings.spaceClick);

        uiNodeTree = $$("node_tree");
        uiInspectPanel = $$("inspect_panel");
        uiResourceList = $$("node_resource_list");

        if (typeof uiEditor != 'undefined') {
            uiEditor["engine.nodeCreated"] = function(data) {
                console.log("[JS] engine.nodeCreated", data);
                const [name, isPrefabStr] = data.split(' ');
                const isPrefab = parseInt(isPrefabStr);
                utility.addItemToNodeTree(name, isPrefab);
                utility.setElementValue("inspect_node_name", name);
            }
            uiEditor["engine.nodeDeleted"] = function(data) {
                console.log("[JS] engine.nodeDeleted", data);
                uiNodeTree.remove(uiNodeTree.getSelectedId());
                utility.adjustTree();
                uiNodeTree.refresh();
                uiBindings.spaceClick(null);
            }
            uiEditor["engine.nodeSelected"] = function(data) {
                console.log("[JS] engine.nodeSelected", data);
                const [name, panel, arg0] = data.split(' ');
                utility.showInspectPanel(panel, arg0);
                utility.setElementValue("inspect_node_name", name);
            }
            uiEditor["engine.nodeRenamed"] = function(data) {
                console.log("[JS] engine.nodeRenamed", data);
                var [success, old, nv] = data.split(' ');
                if (success == "ok") {
                    let isPrefab = uiNodeTree.getItem(old).isPrefab;
                    uiNodeTree.remove(old);
                    utility.addItemToNodeTree(nv, isPrefab);                    
                }
                else {
                    utility.setElementValue($$("inspect_node_name"), old);
                }
            }
            uiEditor["engine.nodeCoordinates"] = function(data) {
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_node_x: x, inspect_node_y: y, inspect_node_z: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.insertNode"] = function(data) {
                console.log("[JS] engine.insertNode", data);
                utility.insertItemToNodeTree(data);
            }
            uiEditor["engine.prefab.editFail"] = function(data) {
                webix.alert("Attempt to edit a prefab with the root node '" + data + "'. But the tree already has a node with that name");
            }
            uiEditor["engine.mesh.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_mesh"].forEach(item => {
                    $$(item).show();
                });
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_mesh_cx: x, inspect_mesh_cy: y, inspect_mesh_cz: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.particles.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_particles"].forEach(item => {
                    $$(item).show();
                    $$(item).expand();
                });

                $$("inspect_ptc_texture").getList().clearAll();
                $$("inspect_ptc_texture").getList().parse(listParticleTextures);

                let desc = utility.parseConfig(data);
                utility.setElementValue("inspect_ptc_emission_time", desc.emitter.emissionTimeMs);
                utility.setElementValue("inspect_ptc_lifetime", desc.emitter.particleLifeTimeMs);
                utility.setElementValue("inspect_ptc_baking_time", desc.emitter.bakingFrameTimeMs);
                utility.setElementValue("inspect_ptc_count", desc.emitter.particlesToEmit);
                utility.setElementValue("inspect_ptc_looped", desc.emitter.looped);
                utility.setElementValue("inspect_ptc_rnd_seed", desc.emitter.randomSeed);
                utility.setElementValue("inspect_ptc_sshape_type", desc.emitter.startShapeType);
                utility.setElementValue("inspect_ptc_sshape_fill", desc.emitter.startShapeFill);
                utility.setElementValue("inspect_ptc_sshape_arg0", desc.emitter.startShapeArgs[0]);
                utility.setElementValue("inspect_ptc_sshape_arg1", desc.emitter.startShapeArgs[1]);
                utility.setElementValue("inspect_ptc_sshape_arg2", desc.emitter.startShapeArgs[2]);
                utility.setElementValue("inspect_ptc_eshape_type", desc.emitter.endShapeType);
                utility.setElementValue("inspect_ptc_eshape_fill", desc.emitter.endShapeFill);
                utility.setElementValue("inspect_ptc_eshape_arg0", desc.emitter.endShapeArgs[0]);
                utility.setElementValue("inspect_ptc_eshape_arg1", desc.emitter.endShapeArgs[1]);
                utility.setElementValue("inspect_ptc_eshape_arg2", desc.emitter.endShapeArgs[2]);
                utility.setElementValue("inspect_ptc_end_offset_x", desc.emitter.endShapeOffset[0]);
                utility.setElementValue("inspect_ptc_end_offset_y", desc.emitter.endShapeOffset[1]);
                utility.setElementValue("inspect_ptc_end_offset_z", desc.emitter.endShapeOffset[2]);
                utility.setElementValue("inspect_ptc_shape_distr", desc.emitter.shapeDistributionType);
                utility.setElementValue("inspect_ptc_orientation", desc.emitter.particleOrientation);
                utility.setElementValue("inspect_ptc_texture", desc.emitter.texture);
            }
            uiEditor["engine.ptcEndOffset"] = function(data) {
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_ptc_end_offset_x: x, inspect_ptc_end_offset_y: y, inspect_ptc_end_offset_z: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.saved"] = async function(data) {
                console.log("[JS] engine.saved", data);
                utility.hostUpdateResources(() => {
                    uiEditor.sendMsg("editor.reloadResources", data);
                });
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic[uiInspectType].forEach(item => {
                    $$(item).show();
                });

                $$("edit_resource_buttons").hide();
            }
            uiEditor["engine.prefab.saveFail"] = function(data) {
                webix.alert(data);
            }
            uiEditor["engine.savePrefab"] = async function(data) {
                try {
                    let prefabDir = await dirResources.getDirectoryHandle("prefabs");
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: "prefab",
                        startIn: prefabDir,
                        types: [
                            {
                                description: "Prefab Descriptions",
                                accept: { "text/plain": [".txt"] },
                            },
                        ],
                    });

                    $$("processing_popup").show();

                    const writable = await fileHandle.createWritable();
                    await writable.write(data);
                    await writable.close();

                    console.log("[JS] Prefab saved as", fileHandle.name);

                    await utility.updateResourcesList();
                    await utility.hostUpdateResources(() => {
                        uiEditor.sendMsg("editor.reloadPrefabs", "");
                    });
                }
                catch (err) {
                    if (err.name != "AbortError") {
                        console.error("[JS] Error saving prefab:", err);
                    }
                }
            }
            uiEditor["engine.resourcesReloaded"] = function(data) {
                $$("processing_popup").hide();
            }
        }

        

    </script>
</body>
</html>
