<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>ack-core editor</title>
    <meta charset="utf-8">
    <link rel="icon" href="data:;base64,=">
    <link rel="stylesheet" href="//cdn.webix.com/edge/skins/mini.css" type="text/css">
    <link rel="stylesheet" href="editor/styles.css">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <script src="editor/components.js" type="text/javascript"></script>
</head>
<body>
    <canvas class="rt" id="render_target"></canvas>
    <div class="editor" id="editor">
        <div class="top" id="top"></div>
        <div class="nodes" id="nodes"></div>
        <div class="inspect" id="inspect"></div>
    </div>

    <script type="text/javascript" charset="utf-8">
        var editorRootDirectory = null;
    </script>    
    <script type="text/javascript" src="wasm.js" binary="editor.wasm"></script>
    <script type="text/javascript" charset="utf-8">
        ["nodes", "inspect", "top"].forEach(name => {
            document.getElementById(name).addEventListener("pointerdown", (event) => {
                event.stopPropagation();
                return false;
            });
            document.getElementById(name).addEventListener("keydown", (event) => {
                if (event.key != "Enter") {
                    event.stopPropagation();
                }
                return false;
            });
            document.getElementById(name).addEventListener("keyup", (event) => {
                if (event.key != "Enter") {
                    event.stopPropagation();
                }
                return false;
            });
            document.getElementById(name).addEventListener("wheel", (event) => {
                event.stopPropagation();
                return false;
            });
        })

        let uiInspectMappingBasic = ["node_0", "node_1_resource_list"];
        var uiInspectMappingEdit = {
            "null" : []
        };
        var resourcesExtMapping = {
            "null" : []
        };
        var texturesRoot = null;
        var uiNodeTree = null;
        var uiNodeName = null;
        var uiNodeTree = null;
        var uiInspectPanel = null;
        var uiInspectType = null;
        var uiResourceList = null;
        var listResources = {
            "null" : []
        };
        var listResFunctions = [];
        var dirBinaryData = null;
        var dirResources = null;

        let utility = {
            openDB: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('fs-db');
                    request.onupgradeneeded = () => {
                        const db = request.result;
                        if (!db.objectStoreNames.contains('handles')) {
                            db.createObjectStore('handles');
                        }
                    };
                    request.onsuccess = () => {
                        const db = request.result;
                        resolve({
                            get(storeName, key) {
                                return new Promise((resolve, reject) => {
                                    const tx = db.transaction(storeName, 'readonly');
                                    const store = tx.objectStore(storeName);
                                    const req = store.get(key);

                                    req.onsuccess = () => resolve(req.result);
                                    req.onerror = () => reject(req.error);
                                });
                            },
                            put(storeName, value, key) {
                                return new Promise((resolve, reject) => {
                                    const tx = db.transaction(storeName, 'readwrite');
                                    const store = tx.objectStore(storeName);
                                    const req = store.put(value, key);

                                    req.onsuccess = () => resolve();
                                    req.onerror = () => reject(req.error);
                                });
                            }
                        });
                    };
                    request.onerror = () => reject(request.error);
                });
            },
            parseConfig: function(text) {
                convertValue = (type, raw) => {
                    raw = raw.trim();
                    if (type == "bool") return raw == "true";
                    if (type == "string") return raw.replace(/"(.*)"/, "$1");
                    if (type == "integer") return parseInt(raw, 10);
                    if (type && /^vector\d+f$/i.test(type)) return raw.split(/\s+/).map(Number);
                    if (type == "number") return parseFloat(raw);
                    return null;
                }
                parseBlock = (body) => {
                    const obj = {};
                    const blockRe = /(\w+)\s*\{([^{}]*\{[^}]*\}[^{}]*|[^{}]*)\}/gs;
                    let match;
                    while ((match = blockRe.exec(body)) != null) {
                        const [, name, inner] = match;
                        obj[name] = parseBlock(inner);
                        body = body.replace(match[0], "");
                    }

                    const lineRe = /(\w+)\s*:\s*(\w+)?\s*=?\s*([^\n{}]+)/g;
                    while ((match = lineRe.exec(body)) != null) {
                        const [, key, type, raw] = match;
                        obj[key] = convertValue(type, raw);
                    }

                    return obj;
                }
                return parseBlock(text);
            },
            getPathDirectoryAndName: async function(dirHandle, relPath) {
                const pathParts = relPath.split('/');
                var handle = dirHandle;
                for (let i = 0; i < pathParts.length; i++) {
                    if (i == pathParts.length - 1) {
                        return [handle, pathParts[i]];
                    }
                    else {
                        handle = await handle.getDirectoryHandle(pathParts[i], { create: true });
                    }
                }
            },
            listFilesInDirectory: async function(baseDirName, dirHandle, ext) {
                var result = [];
                for await (const value of dirHandle.values()) {                    
                    if (value.kind == "directory") {
                        subDirHandle = await dirHandle.getDirectoryHandle(value.name);
                        result = result.concat(await utility.listFilesInDirectory(baseDirName + '/' + value.name, subDirHandle, ext));
                    }
                    else if (value.name.endsWith(ext)) {
                        result.push(baseDirName + '/' + value.name.replace("." + ext, ""));
                    }
                }
                return result;
            },
            updateResourcesList: async function() {
                for (const func of listResFunctions) {
                    await func();
                }
            },
            setWorkingDirectories: async function() {
                try {
                    dirResources = await editorRootDirectory.getDirectoryHandle("resources");
                    dirBinaryData = await editorRootDirectory.getDirectoryHandle("binary_editor").then(r => r.getDirectoryHandle("data"));
                } 
                catch (error) {
                    webix.alert("Can't recognise working directory structure");
                    return false;
                }

                texturesRoot = await dirBinaryData.getDirectoryHandle("textures");
                utility.updateResourcesList();
                return true;
            },
            setElementValue: function(name, value) {
                const e = $$(name);
                e.blockEvent();
                e.setValue(value);
                e.unblockEvent();
            },
            adjustTree: function(id, index) {
                uiNodeTree.define("width", 1000);
                uiNodeTree.resize();
                const leaves = uiNodeTree.$view.getElementsByClassName("webix_tree_leaves")[0];
                uiNodeTree.define("width", leaves.clientWidth);
                uiNodeTree.define("height", leaves.clientHeight);
                uiNodeTree.resize();
            },
            insertItemToNodeTree: function(name) {
                var lastParent = null;
                name.split('.').forEach(node => {
                    const current = lastParent ? lastParent + "." + node : node;
                    if (uiNodeTree.exists(current) == false) {
                        uiNodeTree.data.add({id: current, value: node, open: true}, -1, lastParent );
                    }
                    if (lastParent) {
                        uiNodeTree.open(lastParent);                        
                    }
                    lastParent = current;
                });
            },
            addItemToNodeTree: function(name, isPrefab) {
                utility.insertItemToNodeTree(name);

                if (isPrefab) {
                    uiNodeTree.getItem(name).isPrefab = isPrefab;
                    utility.highlightSubTree(name);
                }
                uiNodeTree.select(name);
            },
            highlightSubTree: function(id) {
                uiNodeTree.addCss(id, "highlight");
                uiNodeTree.data.eachSubItem(id, function(child) {
                    uiNodeTree.addCss(child.id, "highlight");
                });
                uiNodeTree.refresh(id);
            },
            hostUpdateResources: async function(handler) {
                try {
                    const response = await fetch("host_cmd_update");
                    if (!response.ok) {
                        throw new Error("Response status: ${response.status}");
                    }

                    handler();
                } 
                catch (error) {
                    console.error(error.message);
                }
            },
            pointsToString: function(points) {
                let result = "";
                for (const p of points) {
                    result += p.x.toFixed(4) + " " + p.value.toFixed(4) + " " + p.spread.toFixed(4) + " ";
                }
                return result;
            },
        }

        uiBindings = {
            setWorkingDirectory: async function(e) {
                editorRootDirectory = await window.showDirectoryPicker({ mode: "readwrite" });
                const db = await utility.openDB();
                await db.put('handles', editorRootDirectory, 'rootDirectory');                        
                
                let success = await utility.setWorkingDirectories();
                if (success) {
                    document.getElementById("nodes").style.visibility = "visible";
                    $$("top_buttons").show();
                    e.hide();
                }
            },
            initWorkingDirectory: async function() {
                const db = await utility.openDB();
                editorRootDirectory = await db.get("handles", "rootDirectory");
                if (editorRootDirectory) {
                    const permission = await editorRootDirectory.queryPermission({ mode: "readwrite" });
                    if (permission === "granted") {
                        let success = await utility.setWorkingDirectories();
                        if (success) {
                            document.getElementById("nodes").style.visibility = "visible";
                            $$("top_buttons").show();
                            return;
                        }
                    }
                }
                $$("swd").show();
            },
            centerOnObject: function(e) {
                uiEditor.sendMsg("editor.centerOnObject", "");
            },
            axisSwitch: function(e, nv) {
                uiEditor.sendMsg("editor.axisSwitch", nv.toString());
            },
            updateSwitch: function(e, nv) {
                uiEditor.sendMsg("editor.updateSwitch", nv.toString());
            },
            resourceSaveAndExit: function(e) {
                $$("processing_popup").show();
                uiEditor.sendMsg("editor.resource.save", "");
            },
            resourceDiscardAndExit: function(e) {
                uiEditor.sendMsg("editor.stopEditing", "");
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                $$("edit_resource_buttons").hide();
                $$("node_1_resource_list").show();
            },
            treeNewNode: function(e) {
                $$("add_node_menu").show(e.getNode(), {pos: "right"});
            },
            treeDeleteNode: function(e) {
                uiEditor.sendMsg("editor.deleteNode", uiNodeTree.getSelectedId());
            },
            treeNodeSelected: function(id) {
                $$("edit_resource_buttons").hide();
                uiEditor.sendMsg("editor.stopEditing", "");
                uiEditor.sendMsg("editor.selectNode", id);
            },
            spaceClick: function(e) {
                $$("edit_resource_buttons").hide();
                uiEditor.sendMsg("editor.stopEditing", "");
                uiNodeTree.unselectAll();
                uiEditor.sendMsg("editor.clearNodeSelection", "");
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic.forEach(item => {
                    $$(item).hide();
                });
            },
            nodeName: function(e, nv, old) {
                if (/^(?!\.)[A-Za-z0-9_.]+(?<!\.)$/.test(nv) && !uiNodeTree.exists(nv)) {
                    uiEditor.sendMsg("editor.renameNode", old + " " + nv);
                }
                else {
                    utility.setElementValue(e.data.id, old);
                }
            },
            nodeMove: function(e, nv, old) {
                let args = $$("inspect_node_x").getValue() + " " + $$("inspect_node_y").getValue() + " " + $$("inspect_node_z").getValue()
                uiEditor.sendMsg("editor.moveNode", args);
            },
            nodeStartEdit: function(e) {
                uiEditor.sendMsg("editor.startEditing", "");
            },
            prefabSave: function(e) {
                uiEditor.sendMsg("editor.savePrefab", "");
            },
            deleteResource: async function(e) {
                let path = uiResourceList.getSelectedId();
                if (path.length) {
                    try {
                        let [dir, name] = await utility.getPathDirectoryAndName(dirResources, path);
                        const exts = resourcesExtMapping[uiInspectType];
                        for (const ext of exts) {
                            let file = await dir.getFileHandle(name + ext);
                            await file.remove();
                        }
                    } 
                    catch (error) {}
                }
                listResources[uiInspectType] = listResources[uiInspectType].filter(item => item !== path);
                uiResourceList.remove(path);
                uiEditor.sendMsg("editor.setPath", "");
                uiEditor["engine.refresh"]();
            },
            cloneResource: async function(e) {
                let path = uiResourceList.getSelectedId();
                if (path.length) {
                    webix.prompt({
                        title: "Clone with a new name", ok: "Clone", cancel: "Cancel", input: { value: path }
                    }).then(async (newPath) => {
                        $$("processing_popup").show();
                        try {
                            let [dstDir, dstName] = await utility.getPathDirectoryAndName(dirResources, newPath);
                            let [srcDir, srcName] = await utility.getPathDirectoryAndName(dirResources, path);
                            const exts = resourcesExtMapping[uiInspectType];
                            for (const ext of exts) {
                                try {
                                    let file = await dstDir.getFileHandle(dstName + ext);
                                    await file.remove();
                                } 
                                catch (error) {}

                                const srcFileHandle = await srcDir.getFileHandle(srcName + ext);
                                const srcFile = await srcFileHandle.getFile();
                                const dstFileHandle = await dstDir.getFileHandle(dstName + ext, { create: true });
                                const writable = await dstFileHandle.createWritable();
                                await writable.write(srcFile);
                                await writable.close();
                            }
                        } 
                        catch (error) {}
                        await utility.updateResourcesList();
                        await utility.hostUpdateResources(() => {
                            if (!uiResourceList.exists(newPath)) {
                                uiResourceList.add({ id: newPath, value: newPath });
                            }
                            uiEditor.sendMsg("editor.reloadResources", newPath);
                        });
                    });
                }
            }
        }
        
        webix.ui({
            container: "top",
            margin: 0,
            rows: [
                {cols: [
                    {
                        id: "swd",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDDC4", "Set working directory", uiBindings.setWorkingDirectory),
                        ]
                    },
                    {
                        id: "top_buttons",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDCE4", "Load scene"),
                            elements.button("\uD83D\uDCBE", "Save scene"),
                            elements.button("\u2316", "Center on selected object", uiBindings.centerOnObject),
                            elements.toggle('<img src="editor/axis.svg"></img>', '<img src="editor/axis_off.svg"></img>', true, "Hide/show axis", uiBindings.axisSwitch),
                            elements.toggle('\u25FC\uFE0F', '\u25B6', false, "Update every frame", uiBindings.updateSwitch)
                        ]
                    },
                    {},
                    {
                        id: "edit_resource_buttons",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDCBE", "Save resource & Exit", uiBindings.resourceSaveAndExit),
                            elements.button("\uD83D\uDEAB", "Discard changes in the resource & Exit", uiBindings.resourceDiscardAndExit)
                        ]
                    },

                ], autoheight: true}
            ]
        });
        webix.ui({
            container: "nodes",
            cols: [
                {rows: [
                        elements.button("\u2795", "New node", uiBindings.treeNewNode),
                        elements.button("\u274C", "Delete node", uiBindings.treeDeleteNode),
                        elements.button("\uD83D\uDCBE", "Save prefab", uiBindings.prefabSave),
                        {}
                ]},
                {rows: [
                        {
                            id: "node_tree", view: "tree", type: "lineTree", select: true, borderless: true, scroll: false, checkbox: true, data: [],
                            template: "{common.icon()}{common.checkbox()}&nbsp;#value#",
                            css: { "background" : "transparent", "color" : "lightGray" },
                            on: {
                                onAfterOpen: utility.adjustTree,
                                onAfterClose: utility.adjustTree,
                                onAfterAdd: utility.adjustTree,
                                onAfterSelect: uiBindings.treeNodeSelected
                            }
                        },
                        { id: "space"}
                ]}
            ]
        });
        webix.ui({
            id: "add_node_menu", container: "editor", view: "contextmenu", master: "nodes",
            data: [],
            submenuConfig: {
                type: {
                    height: 22
                },
            },
            on: {
                onMenuItemClick: function(id, e, node) {
                    uiEditor.sendMsg("editor.createNode", id);
                }
            }
        });
        webix.ui({
            id: "inspect_panel", container: "inspect", view: "accordion", type: "clean", multi: true, borderless: true, width: 240,
            rows: [
                {
                    id: "node_0", view: "accordionitem", hidden: true, header: "Parameters", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Name:"), {},
                                elements.text("inspect_node_name", "", 183, false, uiBindings.nodeName),
                            ]},
                            {cols: [
                                elements.label("Position:"),
                                {},
                                elements.number("inspect_node_x", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                                elements.number("inspect_node_y", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                                elements.number("inspect_node_z", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "node_1_resource_list", view: "accordionitem", hidden: true, header: "Resource List", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        cols: [
                            {rows: [
                                elements.list("node_resource_list", 500, (id, path) => { uiEditor.sendMsg("editor.setPath", path); }),
                                { height: 16 }
                            ]},
                            {
                                width: 28,
                                css: {"margin-left": "3px !important"},
                                rows: [
                                    elements.button("\uD83D\uDEE0", "Edit resource", uiBindings.nodeStartEdit),
                                    elements.button("\u2FFB", "Clone resource", uiBindings.cloneResource),
                                    elements.button("\u274C", "Delete resource", uiBindings.deleteResource)
                                ]
                            }
                        ]
                    }
                }
            ]
        });
        webix.ui({
            view: "popup",
            id: "processing_popup",
            height: 50, width: 150,
            modal: true,
            position: "center",
            body: {
                padding:{
                    left: 20, right: 20
                },
                rows: [
                    elements.label("Processing...")
                ]
            }
        });
        webix.event($$("space").getNode(), "click", uiBindings.spaceClick);

        uiNodeTree = $$("node_tree");
        uiInspectPanel = $$("inspect_panel");
        uiResourceList = $$("node_resource_list");

        function registerMeshResource() {
            listResFunctions.push(async function() {
                listResources["inspect_mesh"] = await dirResources.getDirectoryHandle("meshes").then(r => utility.listFilesInDirectory("meshes", r, "vox"));
                listResources["inspect_mesh"].sort();
            });

            uiInspectMappingEdit["inspect_mesh"] = ["voxel_mesh_edit_0", "voxel_mesh_edit_1"];
            resourcesExtMapping["inspect_mesh"] = [".vox", ".txt"];

            uiBindings.meshOffset = function(e, nv, old) {
                let args = $$("inspect_mesh_cx").getValue() + " " + $$("inspect_mesh_cy").getValue() + " " + $$("inspect_mesh_cz").getValue()
                uiEditor.sendMsg("editor.mesh.offset", args);
            };

            $$("add_node_menu").add({ id: "1", value: "Add Voxel Mesh" });
            $$("inspect_panel").addView({
                id: "voxel_mesh_edit_0", view: "accordionitem", hidden: true, header: "Edit Mesh", headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Center point:"),
                            {},
                            elements.number("inspect_mesh_cx", null, 54, "11111.0", 0, 0.5, -99, 99, uiBindings.meshOffset),
                            elements.number("inspect_mesh_cy", null, 54, "11111.0", 0, 0.5, -99, 99, uiBindings.meshOffset),
                            elements.number("inspect_mesh_cz", null, 54, "11111.0", 0, 0.5, -99, 99, uiBindings.meshOffset)
                        ]},
                        { height: 16 }
                    ]
                }
            });
            $$("inspect_panel").addView({
                id: "voxel_mesh_edit_1", view: "accordionitem", hidden: true, header: "Animation", headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Name:"), {},
                            elements.text("inspect_mesh_anim_name", "", 183, false),
                        ]},
                        {cols: [
                            elements.label("First:"),
                            elements.number("inspect_mesh_anim_first", null, 44, "11", 0, 1, 0, 99), {},
                            elements.label("Last:"),
                            elements.number("inspect_mesh_anim_last", null, 44, "11", 0, 1, 0, 99), {},
                            elements.label("Ms:"),
                            elements.number("inspect_mesh_anim_time", null, 66, "1111", 0, 10, 0, 9000)
                        ]},
                        {
                            css: {"margin-top": "3px !important"},
                            cols: [
                                {rows: [
                                    elements.list("inspect_mesh_anim_list", 200),
                                    { height: 16 }
                                ]},
                                {
                                    width: 28,
                                    css: {"margin-left": "3px !important"},
                                    rows: [
                                        elements.button("\u2795", "Add animation"),
                                        elements.button("\u25B6", "Play animation"),
                                        elements.button("\u274C", "Delete animation")
                                    ]
                                }
                            ]
                        },
                        { height: 16 }
                    ]
                }
            });

            uiEditor["engine.mesh.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_mesh"].forEach(item => {
                    $$(item).show();
                });
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_mesh_cx: x, inspect_mesh_cy: y, inspect_mesh_cz: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
        }
        function registerParticlesResource() {
            const uiPtcFrameType = [
                { id: 1, value: "10"}, 
                { id: 2, value: "20"},
                { id: 3, value: "50"},
                { id: 4, value: "100"},
            ];
            const uiPtcShapeTypes = [
                { id: 1, value: "Disk"}, 
                { id: 2, value: "Box"}
            ];
            const uiPtcShapeDistribution = [
                { id: 1, value: "Random"}, 
                { id: 2, value: "Shuffled"},
                { id: 3, value: "Linear"}
            ];
            const uiPtcOrientation = [
                { id: 1, value: "Camera"}, 
                { id: 2, value: "Axis"},
                { id: 3, value: "World"}
            ];
            var listParticleTextures = [];

            listResFunctions.push(async function() {
                listResources["inspect_particles"] = await dirResources.getDirectoryHandle("emitters").then(r => utility.listFilesInDirectory("emitters", r, "txt"));
                listResources["inspect_particles"].sort();
                listParticleTextures = await texturesRoot.getDirectoryHandle("particles").then(r => utility.listFilesInDirectory("textures/particles", r, "png"));
                listParticleTextures.sort();                
            });

            uiInspectMappingEdit["inspect_particles"] = ["particles_edit_0", "particles_edit_1", "particles_edit_2"];
            resourcesExtMapping["inspect_particles"] = [".txt", ".tga"];

            uiBindings.particlesEmission = function(e, nv, old) {
                if (e.data.id == "inspect_ptc_lifetime") {
                    let isLooped = parseInt($$("inspect_ptc_looped").getValue());
                    if (isLooped && parseInt(nv) > parseInt($$("inspect_ptc_emission_time").getValue())) {
                        utility.setElementValue(e.data.id, old);
                    }
                }
                if (e.data.id == "inspect_ptc_looped") {
                    let lifeTime = parseInt($$("inspect_ptc_lifetime").getValue());
                    let emissionTime = parseInt($$("inspect_ptc_emission_time").getValue())
                    if (nv && lifeTime > emissionTime) {
                        utility.setElementValue("inspect_ptc_lifetime", emissionTime);
                    }
                }
                let args = $$("inspect_ptc_emission_time").getValue() + " " + $$("inspect_ptc_lifetime").getValue() + " ";
                args += $$("inspect_ptc_baking_time").getValue() + " " + $$("inspect_ptc_count").getValue() + " " + $$("inspect_ptc_looped").getValue() + " ";
                args += $$("inspect_ptc_rnd_seed").getValue();
                uiEditor.sendMsg("editor.particles.emission", args);
            };
            uiBindings.particlesVisual = function(e, nv, old) {
                let args = $$("inspect_ptc_sshape_type").getValue() + " " + $$("inspect_ptc_sshape_fill").getValue() + " ";
                args += $$("inspect_ptc_sshape_arg0").getValue() + " " + $$("inspect_ptc_sshape_arg1").getValue() + " " + $$("inspect_ptc_sshape_arg2").getValue() + " ";
                args += $$("inspect_ptc_eshape_type").getValue() + " " + $$("inspect_ptc_eshape_fill").getValue() + " ";
                args += $$("inspect_ptc_eshape_arg0").getValue() + " " + $$("inspect_ptc_eshape_arg1").getValue() + " " + $$("inspect_ptc_eshape_arg2").getValue() + " ";
                args += $$("inspect_ptc_end_offset_x").getValue() + " " + $$("inspect_ptc_end_offset_y").getValue() + " " + $$("inspect_ptc_end_offset_z").getValue() + " ";
                args += $$("inspect_ptc_shape_distr").getValue() + " " + $$("inspect_ptc_orientation").getValue();
                uiEditor.sendMsg("editor.particles.visual", args);
            };
            uiBindings.particleEmissionGraph = function(e, points) {
                uiEditor.sendMsg("editor.particles.emissionGraph", utility.pointsToString(points));
            };
            uiBindings.particleWidthGraph = function(e, points) {
                uiEditor.sendMsg("editor.particles.widthGraph", utility.pointsToString(points));
            };
            uiBindings.particleHeightGraph = function(e, points) {
                uiEditor.sendMsg("editor.particles.heightGraph", utility.pointsToString(points));
            };
            uiBindings.particleSpeedGraph = function(e, points) {
                uiEditor.sendMsg("editor.particles.speedGraph", utility.pointsToString(points));
            };
            uiBindings.particleAlphaGraph = function(e, points) {
                uiEditor.sendMsg("editor.particles.alphaGraph", utility.pointsToString(points));
            };


            $$("add_node_menu").add({ id: "10", value: "Add Particles" });
            $$("inspect_panel").addView({
                id: "particles_edit_0", view: "accordionitem", hidden: true, header: "Emission", headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Particles emission time (ms):"), {},
                            elements.number("inspect_ptc_emission_time", "", 60, "11111", 1000, 100, 100, 10000, uiBindings.particlesEmission),
                        ]},
                        elements.graphedit("inspect_ptc_emission_graph", "Emission", 1.0, 0.0, 1.0, 0.0, uiBindings.particleEmissionGraph),
                        {cols: [
                            elements.label("Particles life time (ms):"), {},
                            elements.number("inspect_ptc_lifetime", "", 60, "11111", 1000, 100, 100, 10000, uiBindings.particlesEmission),
                        ]},
                        {cols: [
                            elements.label("Baking frame time (ms):"), {},
                            elements.combo("inspect_ptc_baking_time", 1, uiPtcFrameType, 60, uiBindings.particlesEmission),
                        ]},
                        {cols: [
                            elements.label("Amount of particles to emit:"), {},
                            elements.number("inspect_ptc_count", "", 60, "11111", 10, 1, 1, 1000, uiBindings.particlesEmission),
                        ]},
                        {cols: [
                            elements.button("\u25b6", "Restart"), 
                            elements.label("Looped:"),
                            elements.checkbox("inspect_ptc_looped", false, uiBindings.particlesEmission), 
                            elements.label("Seed:"),
                            elements.number("inspect_ptc_rnd_seed", "", 70, "11111111", 100, 1, 0, 99999999, uiBindings.particlesEmission),
                            elements.button("\uD83C\uDFB2", "Reroll")
                        ]},
                        { height: 16 }
                    ]
                }
            });
            $$("inspect_panel").addView({
                id: "particles_edit_1", view: "accordionitem", hidden: true, header: "Visual", headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Start shape type:"), { width: 17 },
                            elements.combo("inspect_ptc_sshape_type", 1, uiPtcShapeTypes, 88, uiBindings.particlesVisual),
                            elements.label("Fill:"),
                            elements.checkbox("inspect_ptc_sshape_fill", false, uiBindings.particlesVisual)
                        ]},
                        {cols: [
                            elements.label("Start shape args:"), {},
                            elements.number("inspect_ptc_sshape_arg0", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                            elements.number("inspect_ptc_sshape_arg1", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                            elements.number("inspect_ptc_sshape_arg2", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                        ]},
                        {cols: [
                            elements.label("End shape type:"), {  },
                            elements.combo("inspect_ptc_eshape_type", 1, uiPtcShapeTypes, 88, uiBindings.particlesVisual),
                            elements.label("Fill:"),
                            elements.checkbox("inspect_ptc_eshape_fill", false, uiBindings.particlesVisual)
                        ]},
                        {cols: [
                            elements.label("End shape args:"), {},
                            elements.number("inspect_ptc_eshape_arg0", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                            elements.number("inspect_ptc_eshape_arg1", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                            elements.number("inspect_ptc_eshape_arg2", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual)
                        ]},
                        {cols: [
                            elements.label("End shape offset:"), {},
                            elements.number("inspect_ptc_end_offset_x", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual),
                            elements.number("inspect_ptc_end_offset_y", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual),
                            elements.number("inspect_ptc_end_offset_z", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual)
                        ]},
                        {cols: [
                            elements.label("Start-to-End Mapping:"), {},
                            elements.combo("inspect_ptc_shape_distr", 1, uiPtcShapeDistribution, 106, uiBindings.particlesVisual),
                        ]},
                        {cols: [
                            elements.label("Particle orientation:"), {},
                            elements.combo("inspect_ptc_orientation", 1, uiPtcOrientation, 106, uiBindings.particlesVisual),
                        ]},
                        {cols: [
                            elements.label("Texture:"), {},
                            elements.combo("inspect_ptc_texture", "", listParticleTextures, 175, (e, nv, old) => {

                            }),
                        ]},
                        { height: 16 }
                    ]
                }
            });
            $$("inspect_panel").addView({
                id: "particles_edit_2", view: "accordionitem", hidden: true, header: "Dynamic", collapsed: true, headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Change width and height together:"),
                            { width: 39 },
                            elements.checkbox("inspect_ptc_with_height_bind", false)
                        ]},
                        elements.graphedit("inspect_ptc_width_graph", "Width", 1.0, 0.0, 99.0, 99.0, uiBindings.particleWidthGraph),
                        elements.graphedit("inspect_ptc_height_graph", "Height", 1.0, 0.0, 99.0, 99.0, uiBindings.particleHeightGraph),
                        elements.graphedit("inspect_ptc_speed_graph", "Speed", 10.0, -999.0, 999.0, 999.0, uiBindings.particleSpeedGraph),
                        elements.graphedit("inspect_ptc_alpha_graph", "Alpha", 1.0, 0.0, 1.0, 1.0, uiBindings.particleAlphaGraph),
                        { height: 16 }
                    ]
                }
            });

            uiEditor["engine.particles.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_particles"].forEach(item => {
                    $$(item).show();
                    $$(item).expand();
                });

                $$("inspect_ptc_texture").getList().clearAll();
                $$("inspect_ptc_texture").getList().parse(listParticleTextures);

                let desc = utility.parseConfig(data);
                utility.setElementValue("inspect_ptc_emission_time", desc.emissionTimeMs);
                utility.setElementValue("inspect_ptc_lifetime", desc.particleLifeTimeMs);
                utility.setElementValue("inspect_ptc_baking_time", desc.bakingFrameType);
                utility.setElementValue("inspect_ptc_count", desc.particlesToEmit);
                utility.setElementValue("inspect_ptc_looped", desc.looped);
                utility.setElementValue("inspect_ptc_rnd_seed", desc.randomSeed);
                utility.setElementValue("inspect_ptc_sshape_type", desc.startShapeType);
                utility.setElementValue("inspect_ptc_sshape_fill", desc.startShapeFill);
                utility.setElementValue("inspect_ptc_sshape_arg0", desc.startShapeArgs[0]);
                utility.setElementValue("inspect_ptc_sshape_arg1", desc.startShapeArgs[1]);
                utility.setElementValue("inspect_ptc_sshape_arg2", desc.startShapeArgs[2]);
                utility.setElementValue("inspect_ptc_eshape_type", desc.endShapeType);
                utility.setElementValue("inspect_ptc_eshape_fill", desc.endShapeFill);
                utility.setElementValue("inspect_ptc_eshape_arg0", desc.endShapeArgs[0]);
                utility.setElementValue("inspect_ptc_eshape_arg1", desc.endShapeArgs[1]);
                utility.setElementValue("inspect_ptc_eshape_arg2", desc.endShapeArgs[2]);
                utility.setElementValue("inspect_ptc_end_offset_x", desc.endShapeOffset[0]);
                utility.setElementValue("inspect_ptc_end_offset_y", desc.endShapeOffset[1]);
                utility.setElementValue("inspect_ptc_end_offset_z", desc.endShapeOffset[2]);
                utility.setElementValue("inspect_ptc_shape_distr", desc.shapeDistributionType);
                utility.setElementValue("inspect_ptc_orientation", desc.particleOrientation);
                utility.setElementValue("inspect_ptc_texture", desc.texture);

                let setGraphValue = (src, name) => {
                    let graph = src.map((_, i, a) => i % 3 === 0 ? { x: a[i], value: a[i + 1], spread: a[i + 2] } : null).filter(Boolean);
                    utility.setElementValue(name, graph);
                };
                setGraphValue(desc.emissionGraphData.trim().split(" ").map(Number), "inspect_ptc_emission_graph");
                setGraphValue(desc.widthGraphData.trim().split(" ").map(Number), "inspect_ptc_width_graph");
                setGraphValue(desc.heightGraphData.trim().split(" ").map(Number), "inspect_ptc_height_graph");
                setGraphValue(desc.speedGraphData.trim().split(" ").map(Number), "inspect_ptc_speed_graph");
                setGraphValue(desc.alphaGraphData.trim().split(" ").map(Number), "inspect_ptc_alpha_graph");
            }
            uiEditor["engine.ptcEndOffset"] = function(data) {
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_ptc_end_offset_x: x, inspect_ptc_end_offset_y: y, inspect_ptc_end_offset_z: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
        }
        function registerRaycastShapeResource() {
            const uiRaycastShapeTypes = [
                { id: 1, value: "Sphere shape approx"}, 
                { id: 2, value: "Convex triangle shape"}
            ];

            listResFunctions.push(async function() {
                listResources["inspect_raycast"] = await dirResources.getDirectoryHandle("raycast").then(r => utility.listFilesInDirectory("raycast", r, "txt"));
                listResources["inspect_raycast"].sort();
            });

            uiInspectMappingEdit["inspect_raycast"] = ["raycast_edit_0"];
            resourcesExtMapping["inspect_raycast"] = [".txt"];

            $$("add_node_menu").add({ id: "20", value: "Add Raycast Shape" });
            $$("inspect_panel").addView({
                id: "raycast_edit_0", view: "accordionitem", hidden: true, header: "Edit Raycast Shape", headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Shape type:"), {},
                            elements.combo("inspect_raycast_shape_type", 1, uiRaycastShapeTypes, 160)
                        ]},
                        {cols: [
                            elements.label("Coord/Arg:"),
                            {},
                            elements.number("inspect_raycast_shape_point_x", null, 44, "111.0", 0.0, 0.1, -999.0, 999.0),
                            elements.number("inspect_raycast_shape_point_y", null, 44, "111.0", 0.0, 0.1, -999.0, 999.0),
                            elements.number("inspect_raycast_shape_point_z", null, 44, "111.0", 0.0, 0.1, -999.0, 999.0),
                            elements.number("inspect_raycast_shape_point_w", null, 44, "111.0", 0.0, 0.1, -999.0, 999.0)
                        ]},
                        {
                            css: {"margin-top": "3px !important"},
                            cols: [
                                {rows: [
                                    elements.list("inspect_raycast_shape_pointlist", 200),
                                    { height: 16 }
                                ]},
                                {
                                    width: 28,
                                    css: {"margin-left": "3px !important"},
                                    rows: [
                                        elements.button("\u2795", "Add point"),
                                        elements.button("\u274C", "Delete point")
                                    ]
                                }
                            ]
                        },
                        { height: 16 }
                    ]
                }
            });

            uiEditor["engine.raycast.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_raycast"].forEach(item => {
                    $$(item).show();
                });
            }
        }
        function registerCollisionShapeResource() {
            const uiCollisionShapeTypes = [
                { id: 1, value: "CircleXZ"}, 
                { id: 2, value: "ObstaclePolygonXZ"}
            ];

            listResFunctions.push(async function() {
                listResources["inspect_collision"] = await dirResources.getDirectoryHandle("collision").then(r => utility.listFilesInDirectory("collision", r, "txt"));
                listResources["inspect_collision"].sort();
            });

            uiInspectMappingEdit["inspect_collision"] = ["collision_edit_0"];
            resourcesExtMapping["inspect_collision"] = [".txt"];

            $$("add_node_menu").add({ id: "21", value: "Add Collision Shape" });
            $$("inspect_panel").addView({
                id: "collision_edit_0", view: "accordionitem", hidden: true, header: "Edit Collision Shape", headerHeight: 10, headerAltHeight: 10,
                css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                body: {
                    padding: 3,
                    rows: [
                        {cols: [
                            elements.label("Shape type:"), {},
                            elements.combo("inspect_collision_shape_type", 1, uiCollisionShapeTypes, 160, (e, nv, old) => {
                                $$("collision_edit_0_type_" + old).hide();
                                $$("collision_edit_0_type_" + nv).show();
                            }),
                        ]},
                        {
                            id: "collision_edit_0_type_1",
                            cols: [
                                elements.label("Radius:"),
                                elements.number("inspect_collision_shape_radius", null, 64, "11.0", 0, 0.1, 1.0, 99.0), {},
                                elements.label("Mass:"),
                                elements.number("inspect_collision_shape_mass", null, 94, "111.0", 0, 0.1, 1.0, 999.0)
                            ]
                        },
                        {
                            id: "collision_edit_0_type_2", hidden: true,
                            rows: [
                                {cols: [
                                    elements.label("XZ Coordinates:"), {},
                                    elements.number("inspect_collision_shape_px", null, 54, "1111.0", 0, 0.1, -999.0, 999.0),
                                    elements.number("inspect_collision_shape_pz", null, 54, "1111.0", 0, 0.1, -999.0, 999.0)
                                ]},
                                {
                                    css: {"margin-top": "3px !important"},
                                    cols: [
                                        {rows: [
                                            elements.list("inspect_collision_shape_pointlist", 200),
                                            { height: 16 }
                                        ]},
                                        {
                                            width: 28,
                                            css: {"margin-left": "3px !important"},
                                            rows: [
                                                elements.button("\u2795", "Add point"),
                                                elements.button("\u274C", "Delete point")
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        { height: 16 }
                    ]
                }
            });

            uiEditor["engine.collision.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_collision"].forEach(item => {
                    $$(item).show();
                });
            }
        }
        function registerPrefabResource() {
            listResFunctions.push(async function() {
                listResources["inspect_prefab"] = await dirResources.getDirectoryHandle("prefabs").then(r => utility.listFilesInDirectory("prefabs", r, "txt"));
                listResources["inspect_prefab"].sort();
            });

            uiInspectMappingEdit["inspect_prefab"] = [];
            resourcesExtMapping["inspect_prefab"] = [".txt"];

            $$("add_node_menu").add({ id: "0", value: "Add Prefab" });
            
            uiEditor["engine.prefab.editFail"] = function(data) {
                webix.alert("Attempt to edit a prefab with the root node '" + data + "'. But the tree already has a node with that name");
            }
            uiEditor["engine.prefab.editing"] = function(data) {
                uiEditor.sendMsg("editor.stopEditing", "");
            }
            uiEditor["engine.prefab.saveFail"] = function(data) {
                webix.alert(data);
            }
            uiEditor["engine.savePrefab"] = async function(data) {
                try {
                    let prefabDir = await dirResources.getDirectoryHandle("prefabs");
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: "prefab",
                        startIn: prefabDir,
                        types: [
                            {
                                description: "Prefab Descriptions",
                                accept: { "text/plain": [".txt"] },
                            },
                        ],
                    });

                    $$("processing_popup").show();

                    const writable = await fileHandle.createWritable();
                    await writable.write(data);
                    await writable.close();

                    console.log("[JS] Prefab saved as", fileHandle.name);

                    await utility.updateResourcesList();
                    await utility.hostUpdateResources(() => {
                        uiEditor.sendMsg("editor.reloadPrefabs", "");
                    });
                }
                catch (err) {
                    if (err.name != "AbortError") {
                        console.error("[JS] Error saving prefab:", err);
                    }
                }
            }
        }

        if (typeof uiEditor != 'undefined') {
            uiEditor["engine.nodeCreated"] = function(data) {
                console.log("[JS] engine.nodeCreated", data);
                const [name, isPrefabStr] = data.split(' ');
                const isPrefab = parseInt(isPrefabStr);
                utility.addItemToNodeTree(name, isPrefab);
                utility.setElementValue("inspect_node_name", name);
            }
            uiEditor["engine.nodeDeleted"] = function(data) {
                console.log("[JS] engine.nodeDeleted", data);
                uiNodeTree.remove(uiNodeTree.getSelectedId());
                utility.adjustTree();
                uiNodeTree.refresh();
                uiBindings.spaceClick(null);
            }
            uiEditor["engine.nodeSelected"] = function(data) {
                console.log("[JS] engine.nodeSelected", data);
                const [name, panel, arg0] = data.split(' ');

                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic.forEach(item => {
                    $$(item).show();
                });

                uiResourceList.clearAll();
                uiResourceList.parse(listResources[panel]);
                if (uiResourceList.exists(arg0)) {
                    uiResourceList.select(arg0);
                }
                else {
                    uiResourceList.unselectAll();
                }

                uiInspectType = panel;
                utility.setElementValue("inspect_node_name", name);
            }
            uiEditor["engine.nodeRenamed"] = function(data) {
                console.log("[JS] engine.nodeRenamed", data);
                var [success, old, nv] = data.split(' ');
                if (success == "ok") {
                    let isPrefab = uiNodeTree.getItem(old).isPrefab;
                    uiNodeTree.remove(old);
                    utility.addItemToNodeTree(nv, isPrefab);
                }
                else {
                    utility.setElementValue($$("inspect_node_name"), old);
                }
            }
            uiEditor["engine.nodeCoordinates"] = function(data) {
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_node_x: x, inspect_node_y: y, inspect_node_z: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.insertNode"] = function(data) {
                console.log("[JS] engine.insertNode", data);
                utility.insertItemToNodeTree(data);
            }
            uiEditor["engine.saved"] = async function(data) {
                console.log("[JS] engine.saved", data);
                utility.hostUpdateResources(() => {
                    uiEditor.sendMsg("editor.reloadResources", data);
                });
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic.forEach(item => {
                    $$(item).show();
                });

                $$("edit_resource_buttons").hide();
            }
            uiEditor["engine.resourcesReloaded"] = function(data) {
                $$("processing_popup").hide();
            }

            registerPrefabResource();
            registerMeshResource();
            registerParticlesResource();
            registerRaycastShapeResource();
            registerCollisionShapeResource();
        }

        uiBindings.initWorkingDirectory();

    </script>
</body>
</html>
