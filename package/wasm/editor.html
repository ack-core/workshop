<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>ack-core editor</title>
    <meta charset="utf-8">
    <link rel="icon" href="data:;base64,=">
    <link rel="stylesheet" href="//cdn.webix.com/edge/skins/mini.css" type="text/css">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <style>
        html, body {
            margin: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0.0, 0.0, 0.0, 1.0);
        }
        .rt {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            z-index: -999;
        }
        .editor {
            background: transparent;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .top {
            background: rgba(255, 255, 255, 0.7);
            position: fixed;
            top: 0;
            left: 0;
            height: min-content;
            width: 100%;
        }
        .nodes {
            background: rgba(255, 255, 255, 0.5);
            position: fixed;
            overflow-y: auto;
            scrollbar-color: rgba(255, 255, 255, 0.6) transparent;
            top: 25px;
            left: 0;
            min-width: 100px;
            height: calc(100vh - 25px);
            visibility: hidden;
        }
        .output {
            background: rgba(255, 255, 255, 0.6);
            position: fixed;
            overflow-y: scroll;
            bottom: 0;
            right: 0;
            height: 100px;
            min-width: 300px;
            font-size: 8pt;
            font-family: Courier New;
        }
        .inspect {
            background: transparent;
            position: fixed;
            overflow-y: auto;
            top: 25px;
            right: 0;
            min-width: 100px;
        }
        .webix_tree_img {
            color: lightGrey;
            background-color: transparent;
            background-position: top 0px right 0.5px;
        }
        .webix_el_text input {
            padding: 2px;
        }
        .webix_inp_label, .webix_el_box {
            font-size: 8pt !important;
        }
        .webix_list_item, .webix_list .webix_list_item.webix_selected {
            line-height: 20px;
            padding-top: 0;
        }
        .webix_button {
            padding: 0.5px 2px 0px 2px;
            color: #8888a3 !important;
        }
        .webix_secondary .webix_button {
            background: #d8d8d8;
        }
        .webix_view .webix_list {
            background-color: rgba(255, 255, 255, 0.6);
        }
        .webix_el_text input {
            background-color: #eeeeee;
        }
        .webix_el_combo input {
            padding: 0px 2px 0px 2px !important;
        }
        .webix_el_combo .webix_input_icon {
            width: 19px;
        }
        .webix_custom_checkbox {
            margin-top: -2px;
            color: #8888a3 !important;
        }
        .webix_segment_0.webix_selected, .webix_segment_1.webix_selected, .webix_segment_N.webix_selected {
            background-color: #cfcfef;
        }
        .webix_segment_0.webix_selected:focus, .webix_segment_1.webix_selected:focus, .webix_segment_N.webix_selected:focus {
            background-color: #cfcfef;
        }
        .webix_segment_0.webix_selected:hover, .webix_segment_1.webix_selected:hover, .webix_segment_N.webix_selected:hover {
            background-color: #cfcfef;
        }
        .webix_accordionitem_button {
            font-size: 10px !important;
            width: 10px !important;
            height: 10px !important;
            color: #475466 !important;
        }
        .webix_accordionitem .webix_accordionitem_header {
            line-height: 10px;
            font-size: 6pt;
            text-align: right;
            background-color: lightGray;
        }
        .webix_accordionitem.collapsed .webix_accordionitem_header {
            background-color: lightGray;
        }
        
        input[type=number]::-webkit-inner-spin-button {
            transform: scaleX(0.75);
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
        }
        @media screen and (orientation:portrait) {
            .rt, .editor {
                visibility: hidden;
            }
            .output {
                top: 0;
                left: 0;
                height: 100vh;
            }
        }
        @media screen and (orientation:landscape) {
            html, body {
                position: fixed;
            }
        }

    </style>
</head>
<body>
    <canvas class="rt" id="render_target"></canvas>
    <div class="editor" id="editor">
        <div class="top" id="top"></div>
        <div class="nodes" id="nodes"></div>
        <div class="inspect" id="inspect"></div>
        <div class="output" id="output"></div>
    </div>

    <script type="text/javascript" charset="utf-8">
        var editorRootDirectory = null;
    </script>    
    <script type="text/javascript" src="wasm.js" binary="editor.wasm"></script>
    <script type="text/javascript" charset="utf-8">
        ["nodes", "output", "inspect", "top"].forEach(name => {
            document.getElementById(name).addEventListener("pointerdown", (event) => {
                event.stopPropagation();
                return false;
            });
            document.getElementById(name).addEventListener("keydown", (event) => {
                event.stopPropagation();
                return false;
            });
            document.getElementById(name).addEventListener("keyup", (event) => {
                event.stopPropagation();
                return false;
            });
            document.getElementById(name).addEventListener("wheel", (event) => {
                event.stopPropagation();
                return false;
            });
        })

        const uiInspectMappingBasic = {
            "null" : [],
            "inspect_mesh" : ["node_0", "node_1_resource_list"],
            "inspect_particles" : ["node_0", "node_1_resource_list"]
        };
        const uiInspectMappingEdit = {
            "null" : [],
            "inspect_mesh" : ["voxel_mesh_edit_0"],
            "inspect_particles" : ["particles_edit_0", "particles_edit_1"]
        };
        const uiPtcShapeTypes = [
            { id: 1, value: "Disk"}, 
            { id: 2, value: "Box"}
        ];
        const uiPtcShapeDistribution = [
            { id: 1, value: "Random"}, 
            { id: 2, value: "Shuffled"},
            { id: 3, value: "Linear"}
        ];
        const uiPtcOrientation = [
            { id: 1, value: "Camera"}, 
            { id: 2, value: "Axis"},
            { id: 3, value: "World"}
        ];

        var uiNodeTree = null;
        var uiNodeName = null;
        var uiNodeTree = null;
        var uiInspectPanel = null;
        var uiInspectType = null;
        var uiResourceList = null;
        var listParticleTextures = [];
        var listResources = {};
        var dirBinaryData = null;
        var dirResources = null;

        let utility = {
            listFilesInDirectory: async function(baseDirName, dirHandle, ext) {
                var result = [];
                for await (const value of dirHandle.values()) {                    
                    if (value.kind == "directory") {
                        subDirHandle = await dirHandle.getDirectoryHandle(value.name);
                        result = result.concat(await utility.listFilesInDirectory(baseDirName + '/' + value.name, subDirHandle, ext));
                    }
                    else if (value.name.endsWith(ext)) {
                        result.push(baseDirName + '/' + value.name.replace("." + ext, ""));
                    }
                }
                return result;
            },
            setWorkingDirectory: async function() {
                editorRootDirectory = await window.showDirectoryPicker({ mode: "readwrite" });
                dirResources = await editorRootDirectory.getDirectoryHandle("resources");
                dirBinaryData = await editorRootDirectory.getDirectoryHandle("binary").then(r => r.getDirectoryHandle("data"));
                let texturesRoot = await dirBinaryData.getDirectoryHandle("textures");

                listParticleTextures = await texturesRoot.getDirectoryHandle("particles").then(r => utility.listFilesInDirectory("textures/particles", r, "png"));
                listParticleTextures.sort();

                listResources["null"] = []
                listResources["inspect_mesh"] = await dirBinaryData.getDirectoryHandle("meshes").then(r => utility.listFilesInDirectory("meshes", r, "vxm"));
                listResources["inspect_mesh"].sort();
                listResources["inspect_particles"] = await dirBinaryData.getDirectoryHandle("emitters").then(r => utility.listFilesInDirectory("emitters", r, "bin"));
                listResources["inspect_particles"].sort();
            },
            setElementValue: function(name, value) {
                const e = $$(name);
                e.blockEvent();
                e.setValue(value);
                e.unblockEvent();
            },
            adjustTree: function(id, index) {
                uiNodeTree.define("width", 1000);
                uiNodeTree.resize();
                const leaves = uiNodeTree.$view.getElementsByClassName("webix_tree_leaves")[0];
                uiNodeTree.define("width", leaves.clientWidth);
                uiNodeTree.define("height", leaves.clientHeight);
                uiNodeTree.resize();
            },
            addItemToNodeTree: function(name) {
                var lastParent = null;
                name.split('.').forEach(node => {
                    const current = lastParent ? lastParent + "." + node : node;
                    if (uiNodeTree.exists(current) == false) {
                        uiNodeTree.data.add({id: current, value: node, open: true}, -1, lastParent );
                    }

                    lastParent = current;
                });

                uiNodeTree.select(name);
            },
            showInspectPanel: function(panel, arg0) {
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic[panel].forEach(item => {
                    $$(item).show();
                });

                uiResourceList.clearAll();
                uiResourceList.parse(listResources[panel]);
                if (uiResourceList.exists(arg0)) {
                    uiResourceList.select(arg0);
                }
                else {
                    uiResourceList.unselectAll();
                }

                uiInspectType = panel;
            }
        }

        let elements = {
            label: function(value, align = "left") {
                return { 
                    view: "label", label: value, height: 24, autowidth: true, align: align
                };
            },
            button: function(value, tooltip, action = null) {
                const id = webix.uid().toString();
                return { 
                    id: id, view: "button",  value: value, width: 24, height: 24, tooltip: { template: tooltip, delay: 800 },
                    click: () => { if (action) action($$(id)); }
                };
            },
            toggle: function(on, off, value, tooltip, action = null) {
                const id = webix.uid().toString();
                return {
                    id: id, view: "toggle", offLabel: off, onLabel: on, width: 24, height: 24, value: value,
                    tooltip: { template: tooltip, delay: 800 },
                    on: {
                        onChange: function(nv) {
                            if (action) action($$(id), nv === "true");
                        }
                    }
                }
            },
            text: function(id, value, width, readonly, action = null) {
                return { 
                    id: id, view: "text", type: "text", value: value, width: width, height: 24, readonly: readonly, 
                    on: {
                        onEnter: function() { this.blur(); },
                        onChange: function(nv, old) {
                            if (action) action($$(id), nv, old);
                        }
                    }
                };
            },
            number: function(id, tooltip, width, format, value, step, min, max, action = null) {
                return { 
                    id: id, view: "text", type:"number", format: format, value: value, height: 24, width: width, 
                    tooltip: { template: tooltip, delay: 800 },
                    on: {
                        onEnter: function(e) {
                            let element = $$(id);
                            const currentValue = element.getText(); 
                            const v = Math.max(min, Math.min(max, currentValue));
                            element.setValue(v.toString());
                            this.blur(); 
                        },
                        onChange: function(nv, old) {
                            if (action) action($$(id), nv, old);
                        }
                    },
                    attributes:{ step: step, min: min, max: max }
                };
            },
            combo: function(id, value, list, width, action = null) {
                return {
                    id: id, view: "combo", container: "editor", value: value, width: width, height: 24, 
                    options:{
                        view: "suggest",
                        body: {
                            view: "list",
                            type: {
                                height: 22
                            },
                            data: list,
                        }
                    },
                    on: {
                        onChange: (nv, old) => { if (action) action($$(id), nv, old); }
                    }
                };
            },
            checkbox: function(id, value, action = null) {
            	return {
                    id: id, view: "checkbox", value: value, height: 24,
                    on: {
                        onChange: (nv, old) => { if (action) action($$(id), nv, old); }
                    }
                }
            }
        }

        uiBindings = {
            setWorkingDirectory: async function(e) {
                await utility.setWorkingDirectory();
                document.getElementById("nodes").style.visibility = "visible";
                $$("top_buttons").show();
                e.hide();
            },
            resourceSaveAndExit: function(e) {
                $$("processing_popup").show();
                uiEditor.sendMsg("editor.resource.save", "");
            },
            resourceDiscardAndExit: function(e) {
                uiEditor.sendMsg("editor.stopEditing", "");
                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                $$("edit_resource_buttons").hide();
                $$("node_1_resource_list").show();
            },
            treeNewNode: function(e) {
                $$("add_node_menu").show(e.getNode(), {pos: "right"});
            },
            spaceClick: function(e) {
                uiEditor.sendMsg("editor.stopEditing", "");
                uiNodeTree.unselectAll();
                uiEditor.sendMsg("editor.clearNodeSelection", "");
                utility.showInspectPanel("null", "");
            },
            nodeName: function(e, nv, old) {
                if (/^[A-Za-z0-9_\.]*$/.test(nv) && !uiNodeTree.exists(nv)) {
                    uiEditor.sendMsg("editor.renameNode", old + " " + nv);
                }
                else {
                    utility.setElementValue(e.data.id, old);
                }
            },
            nodeMove: function(e, nv, old) {
                let args = $$("inspect_node_x").getValue() + " " + $$("inspect_node_y").getValue() + " " + $$("inspect_node_z").getValue()
                uiEditor.sendMsg("editor.moveNode", args);
            },
            nodeStartEdit: function(e) {
                uiEditor.sendMsg("editor.startEditing", "");
            },
            meshOffset: function(e, nv, old) {
                let args = $$("inspect_mesh_cx").getValue() + " " + $$("inspect_mesh_cy").getValue() + " " + $$("inspect_mesh_cz").getValue()
                uiEditor.sendMsg("editor.mesh.offset", args);
            },
            particlesEmission: function(e, nv, old) {
                if (e.data.id == "inspect_ptc_lifetime") {
                    let isLooped = parseInt($$("inspect_ptc_looped").getValue());
                    if (isLooped && parseInt(nv) > parseInt($$("inspect_ptc_emission_time").getValue())) {
                        utility.setElementValue(e.data.id, old);
                    }
                }
                if (e.data.id == "inspect_ptc_looped") {
                    let lifeTime = parseInt($$("inspect_ptc_lifetime").getValue());
                    let emissionTime = parseInt($$("inspect_ptc_emission_time").getValue())
                    if (nv && lifeTime > emissionTime) {
                        utility.setElementValue("inspect_ptc_lifetime", emissionTime);
                    }
                }
                let args = $$("inspect_ptc_emission_time").getValue() + " " + $$("inspect_ptc_lifetime").getValue() + " ";
                args += $$("inspect_ptc_baking_time").getValue() + " " + $$("inspect_ptc_count").getValue() + " " + $$("inspect_ptc_looped").getValue() + " ";
                uiEditor.sendMsg("editor.particles.emission", args);
            },
            particlesVisual: function(e, nv, old) {
                let args = $$("inspect_ptc_sshape_type").getValue() + " " + $$("inspect_ptc_sshape_fill").getValue() + " ";
                args += $$("inspect_ptc_sshape_arg0").getValue() + " " + $$("inspect_ptc_sshape_arg1").getValue() + " " + $$("inspect_ptc_sshape_arg2").getValue() + " ";
                args += $$("inspect_ptc_eshape_type").getValue() + " " + $$("inspect_ptc_eshape_fill").getValue() + " ";
                args += $$("inspect_ptc_eshape_arg0").getValue() + " " + $$("inspect_ptc_eshape_arg1").getValue() + " " + $$("inspect_ptc_eshape_arg2").getValue() + " ";
                args += $$("inspect_ptc_end_offset_x").getValue() + " " + $$("inspect_ptc_end_offset_y").getValue() + " " + $$("inspect_ptc_end_offset_z").getValue() + " ";
                args += $$("inspect_ptc_shape_distr").getValue() + " " + $$("inspect_ptc_orientation").getValue();
                uiEditor.sendMsg("editor.particles.visual", args);
            }
        }
        
        webix.ui({
            container: "top",
            margin: 0,
            rows: [
                {cols: [
                    elements.button("\uD83D\uDDC4", "Set working directory", uiBindings.setWorkingDirectory),
                    {
                        id: "top_buttons",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDCE4", "Load scene"),
                            elements.button("\uD83D\uDCBE", "Save scene"),
                            elements.toggle('<img src="editor/arrows.svg"></img>', '<img src="editor/arrows.svg"></img>', true, "Hide/show moving tool", (e, nv) => {})
                        ]
                    },
                    {},
                    {
                        id: "edit_resource_buttons",
                        hidden: true,
                        cols: [
                            elements.button("\uD83D\uDCBE", "Save & Exit", uiBindings.resourceSaveAndExit),
                            elements.button("\uD83D\uDEAB", "Discard & Exit", uiBindings.resourceDiscardAndExit)
                        ]
                    },

                ], autoheight: true}
            ]
        });
        webix.ui({
            container: "nodes",
            cols: [
                {rows: [
                        elements.button("\u2795", "New node", uiBindings.treeNewNode),
                        elements.button("\u274C", "Delete node", (e) => {}),
                        {}
                ]},
                {rows: [
                        {
                            id: "node_tree", view: "tree", type: "lineTree", select: true, borderless: true, scroll: false, data: [],
                            template: "{common.icon()}&nbsp;#value#",
                            css: { "background" : "transparent", "color" : "lightGray" },
                            on: {
                                onAfterOpen: utility.adjustTree,
                                onAfterClose: utility.adjustTree,
                                onAfterAdd: utility.adjustTree,
                                // onBeforeSelect: function(id, selection) {
                                //     return selection == false; // || uiNodeTree.isBranch(id) == false;
                                // },
                                onAfterSelect: function(id) {
                                    uiEditor.sendMsg("editor.selectNode", id);
                                }
                            }
                        },
                        { id: "space"}
                ]}
            ]
        });
        webix.ui({
            id: "add_node_menu", container: "editor", view: "contextmenu", master: "nodes",
            data: [
                { id: "0", value: "Add Voxel Mesh" },
                { id: "1", value: "Add Particles" }
            ],
            submenuConfig: {
                type: {
                    height: 22
                },
            },
            on: {
                onMenuItemClick: function(id, e, node) {
                    uiEditor.sendMsg("editor.createNode", id);
                }
            }
        });
        webix.ui({
            id: "inspect_panel", container: "inspect", view: "accordion", type: "clean", multi: true, borderless: true,
            rows: [
                {
                    id: "node_0", view: "accordionitem", hidden: true, header: "Parameters", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Name:"),
                                elements.text("inspect_node_name", "", 183, false, uiBindings.nodeName),
                            ]},
                            {cols: [
                                elements.label("Position:"),
                                {},
                                elements.number("inspect_node_x", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                                elements.number("inspect_node_y", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                                elements.number("inspect_node_z", null, 54, "11111.0", 0.0, 0.1, -9999.0, 9999.0, uiBindings.nodeMove),
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "node_1_resource_list", view: "accordionitem", hidden: true, header: "Resource List", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        cols: [
                            {rows: [
                                {
                                    id: "node_resource_list",
                                    view: "list", height: 300, select: true,
                                    css: {"margin": "3px !important"},
                                    type: {
                                        height: 22
                                    },
                                    data: ["lib/path/aaa1", "lib/path/bbbbbbbb1", "lib/path/cc1"],
                                    on: {
                                        onAfterSelect: function(path) {
                                            uiEditor.sendMsg("editor.setPath", path);
                                        }
                                    }
                                },
                                { height: 16 }
                            ]},
                            {
                                width: 28,
                                css: {"margin-left": "3px !important"},
                                rows: [
                                    elements.button("\uD83D\uDEE0", "Edit resource", uiBindings.nodeStartEdit),
                                    elements.button(" ", "???")
                                ]
                            }
                        ]
                    }
                },
                {
                    id: "voxel_mesh_edit_0", view: "accordionitem", hidden: true, header: "Edit Mesh", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Center point:"),
                                {},
                                elements.number("inspect_mesh_cx", null, 44, "11111", 0, 1, -99, 99, uiBindings.meshOffset),
                                elements.number("inspect_mesh_cy", null, 44, "11111", 0, 1, -99, 99, uiBindings.meshOffset),
                                elements.number("inspect_mesh_cz", null, 44, "11111", 0, 1, -99, 99, uiBindings.meshOffset)
                            ]},
                            { height: 16 }
                        ]
                    }
                },                
                {
                    id: "particles_edit_0", view: "accordionitem", hidden: true, header: "Emission", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Particles emission time (ms):"), {},
                                elements.number("inspect_ptc_emission_time", "", 60, "11111", 1000, 1, 1, 4000, uiBindings.particlesEmission),
                            ]},
                            {cols: [
                                elements.label("Particles life time (ms):"), {},
                                elements.number("inspect_ptc_lifetime", "", 60, "11111", 1000, 1, 1, 4000, uiBindings.particlesEmission),
                            ]},
                            {cols: [
                                elements.label("Baking frame time (ms):"), {},
                                elements.number("inspect_ptc_baking_time", "", 60, "11111", 33, 1, 10, 100, uiBindings.particlesEmission)
                            ]},
                            {cols: [
                                elements.label("Amount of particles to emit:"), {},
                                elements.number("inspect_ptc_count", "", 60, "11111", 10, 1, 1, 1000, uiBindings.particlesEmission),
                            ]},
                            {cols: [
                                elements.button("\u25b6", "Restart"), 
                                elements.label("Looped:"),
                                elements.checkbox("inspect_ptc_looped", false, uiBindings.particlesEmission), { width: 10 },
                                elements.label("Seed:"),
                                elements.text("inspect_ptc_rnd_seed", "0", 70, true),
                                elements.button("\uD83C\uDFB2", "Reroll and reevaluate all randomized parameters")
                            ]},
                            { height: 16 }
                        ]
                    }
                },
                {
                    id: "particles_edit_1", view: "accordionitem", hidden: true, header: "Visual", headerHeight: 10, headerAltHeight: 10,
                    css: { "background" : "rgba(255, 255, 255, 0.7)", "color" : "lightGray" },
                    body: {
                        padding: 3,
                        rows: [
                            {cols: [
                                elements.label("Start shape type:"), { width: 2 },
                                elements.combo("inspect_ptc_sshape_type", 0, uiPtcShapeTypes, 88, uiBindings.particlesVisual),
                                elements.label("Fill:"),
                                elements.checkbox("inspect_ptc_sshape_fill", false, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("Start shape args:"), {},
                                elements.number("inspect_ptc_sshape_arg0", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_sshape_arg1", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_sshape_arg2", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                            ]},
                            {cols: [
                                elements.label("End shape type:"), { width: 8 },
                                elements.combo("inspect_ptc_eshape_type", 0, uiPtcShapeTypes, 88, uiBindings.particlesVisual),
                                elements.label("Fill:"),
                                elements.checkbox("inspect_ptc_eshape_fill", false, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("End shape args:"), {},
                                elements.number("inspect_ptc_eshape_arg0", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_eshape_arg1", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_eshape_arg2", "", 44, "11111.0", 0.0, 0.1, 0.0, 99.0, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("End shape offset:"), {},
                                elements.number("inspect_ptc_end_offset_x", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_end_offset_y", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual),
                                elements.number("inspect_ptc_end_offset_z", "", 44, "11111.0", 0.0, 0.1, -99.0, 99.0, uiBindings.particlesVisual)
                            ]},
                            {cols: [
                                elements.label("Start-to-End Mapping:"),
                                elements.combo("inspect_ptc_shape_distr", 0, uiPtcShapeDistribution, 106, uiBindings.particlesVisual),
                            ]},
                            {cols: [
                                elements.label("Particle orientation:"), {},
                                elements.combo("inspect_ptc_orientation", 0, uiPtcOrientation, 106, uiBindings.particlesVisual),
                            ]},
                            {cols: [
                                elements.label("Texture:"),
                                elements.combo("inspect_ptc_texture", "", listParticleTextures, 175, (e, nv, old) => {

                                }),
                            ]},
                            { height: 16 }
                        ]
                    }
                }
            ]
        });
        webix.ui({
            view: "popup",
            id: "processing_popup",
            height: 50,
            width: 150,
            modal: true,
            position: "center",
            body: {
                padding:{
                    left: 20, right: 20
                },
                rows: [
                    elements.label("Processing...")
                ]
            }
        });
        webix.event($$("space").getNode(), "click", uiBindings.spaceClick);

        uiNodeTree = $$("node_tree");
        uiInspectPanel = $$("inspect_panel");
        uiResourceList = $$("node_resource_list");

        if (typeof uiEditor != 'undefined') {
            uiEditor["engine.nodeCreated"] = function(data) {
                console.log("[JS] engine.nodeCreated ", data);
                const [name, panel] = data.split(' ');
                utility.addItemToNodeTree(name);
                utility.setElementValue("inspect_node_name", name);
            }
            uiEditor["engine.nodeSelected"] = function(data) {
                console.log("[JS] engine.nodeSelected ", data);
                const [name, panel, arg0] = data.split(' ');
                utility.showInspectPanel(panel, arg0);
                utility.setElementValue("inspect_node_name", name);
            }
            uiEditor["engine.nodeRenamed"] = function(data) {
                console.log("[JS] engine.nodeRenamed ", data);
                var [old, nv] = data.split(' ');
                do {
                    parentId = uiNodeTree.getParentId(old);
                    uiNodeTree.remove(old);
                    old = parentId;
                }
                while (uiNodeTree.isBranch(old) == false);
                utility.addItemToNodeTree(nv);
            }
            uiEditor["engine.nodeCoordinates"] = function(data) {
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_node_x: x, inspect_node_y: y, inspect_node_z: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.mesh.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_mesh"].forEach(item => {
                    $$(item).show();
                });
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_mesh_cx: x, inspect_mesh_cy: y, inspect_mesh_cz: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.particles.editing"] = function(data) {
                $$("node_1_resource_list").hide();
                $$("edit_resource_buttons").show();
                uiInspectMappingEdit["inspect_particles"].forEach(item => {
                    $$(item).show();
                });

                $$("inspect_ptc_texture").getList().clearAll();
                $$("inspect_ptc_texture").getList().parse(listParticleTextures);

                const keys = [
                    'inspect_ptc_emission_time', 'inspect_ptc_lifetime', 'inspect_ptc_baking_time', 'inspect_ptc_count', 'inspect_ptc_looped', 'inspect_ptc_rnd_seed',
                    'inspect_ptc_sshape_type', 'inspect_ptc_sshape_fill', 'inspect_ptc_sshape_arg0', 'inspect_ptc_sshape_arg1', 'inspect_ptc_sshape_arg2',
                    'inspect_ptc_eshape_type', 'inspect_ptc_eshape_fill', 'inspect_ptc_eshape_arg0', 'inspect_ptc_eshape_arg1', 'inspect_ptc_eshape_arg2',
                    'inspect_ptc_end_offset_x', 'inspect_ptc_end_offset_y', 'inspect_ptc_end_offset_z',
                    'inspect_ptc_shape_distr', 'inspect_ptc_orientation', 'inspect_ptc_texture'
                ];
                const values = data.split(' ');
                keys.forEach((key, i) => {
                    utility.setElementValue(key, values[i]);
                });
            }
            uiEditor["engine.ptcEndOffset"] = function(data) {
                const [x, y, z] = data.split(' ');
                Object.entries({inspect_ptc_end_offset_x: x, inspect_ptc_end_offset_y: y, inspect_ptc_end_offset_z: z}).forEach(([k, v]) => {
                    utility.setElementValue(k, v);
                });
            }
            uiEditor["engine.saved"] = async function(data) {
                if (parseInt(data)) {
                    try {
                        const response = await fetch("host_cmd_update");
                        if (!response.ok) {
                            throw new Error("Response status: ${response.status}");
                        }

                        uiEditor.sendMsg("editor.reload", "");
                    } 
                    catch (error) {
                        console.error(error.message);
                    }
                }

                uiInspectMappingEdit[uiInspectType].forEach(item => {
                    $$(item).hide();
                });
                uiInspectMappingBasic[uiInspectType].forEach(item => {
                    $$(item).show();
                });

                $$("edit_resource_buttons").hide();
                $$("processing_popup").hide();
            }
        }

        

    </script>
</body>
</html>
